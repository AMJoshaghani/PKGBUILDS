#!/bin/bash

# Maintainer: EndeavourOS-Team <info@endeavouros.com>

pkgname=EndeavourOS-archiso
pkgver=0.1
pkgrel=2
pkgdesc="Build EndeavourOS-archiso"
arch=(any)
makedepends=(archiso arch-install-scripts git)
source=(git+https://github.com/endeavouros-team/EndeavourOS-archiso.git)
sha512sums=(SKIP)

build() {
    local build_rootdir="$(dirname "$PWD")"   # $srcdir/..
    local _cmds=()
    local cleanup=cleanup.bash

    cd $pkgname

    _cmds+=(pacman -Syyu \;)       # make sure system is updated

    _cmds+=(./fix_permissions.sh \;)
    _cmds+=(./build.sh -v \;)
    _cmds+=(cd "$build_rootdir" \;)
    _cmds+=(mv "$srcdir/$pkgname"/out/*.iso . \;)
    _cmds+=(chown $LOGNAME:$LOGNAME *.iso)

    su -c "${_cmds[*]}"
    sync

    cd "$build_rootdir"

    cat <<EOF > $cleanup
#!/bin/bash
sudo rm -f  $build_rootdir/$pkgname-*.pkg.tar.*
sudo rm -rf $build_rootdir/$pkgname
sudo rm -rf $build_rootdir/pkg
sudo rm -rf $build_rootdir/src
EOF

    echo ""
    echo "#######################################################################"
    echo ""
    echo "The new ISO is here:"
    ls -1 "$build_rootdir"/*.iso
    echo ""
    echo "To clean up all except the ISO, run command:"
    echo "    bash $cleanup"
    echo ""
    echo "#######################################################################"
    echo ""
}

package() {
    echo Done.
}

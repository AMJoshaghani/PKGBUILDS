#!/bin/bash

# Maintainer: EndeavourOS-Team <info@endeavouros.com>

pkgname=EndeavourOS-archiso
pkgver=0.7
pkgrel=2
pkgdesc="Build EndeavourOS-archiso"
arch=(any)
makedepends=(archiso mkinitcpio-archiso git squashfs-tools)
source=(git+https://github.com/endeavouros-team/EndeavourOS-archiso.git)
sha512sums=(SKIP)


_check_repo_in_pacman_conf() {
    local reponame="endeavouros_calamares"
    local conf=/etc/pacman.conf

    if [ -z "$(grep "^\[$reponame\]$" $conf)" ] ; then
        echo "Sorry, repo [$reponame] is not found in $conf." >&2
        read -p "Add it now and update system (Y/n)? " >&2
        case "$REPLY" in
            [yY]* | "")
                local conftmp="$(mktemp -u "$HOME"/pacman.conf.tmp.XXXX)"
                cp $conf $conftmp
                cat <<EOF >> $conftmp

[$reponame]
Server = https://github.com/endeavouros-team/mirrors/releases/download/\$repo
EOF
                sudo cp $conftmp $conf || { rm -f $conftmp ; return 1 ; }
                rm -f $conftmp
                ;;
            *)
                return 1
                ;;
        esac
    fi
}

_create_cleanup_script() {
    cat <<EOF > "$cleanup"
#!/bin/bash
sudo rm -f  $build_rootdir/${pkgname}-*.pkg.tar.*
sudo rm -rf $build_rootdir/${pkgname}
sudo rm -rf $build_rootdir/pkg
sudo rm -rf $build_rootdir/src
rm -f $cleanup
EOF
}

_select_calamares_type() {
    while true ; do
        read -p "Build with calamares 'test' or 'current'? [current] " >&2
        case "$REPLY" in
            "" | current)
                sed -i packages.x86_64 \
                    -e 's|^#[ ]*calamares_current[ ]*$|calamares_current|' \
                    -e 's|^[ ]*calamares_test[ ]*$|#calamares_test|'
                break
                ;;
            test)
                sed -i packages.x86_64 \
                    -e 's|^[ ]*calamares_current[ ]*$|#calamares_current|' \
                    -e 's|^#[ ]*calamares_test[ ]*$|calamares_test|'
                break
                ;;
        esac
    done
}

build() {
    ###################################################
    # Check that we have calamares repo properly set up.
    ###################################################

    _check_repo_in_pacman_conf

    ###################################################
    # Create a cleanup script.
    ###################################################

    local build_rootdir="$srcdir/.."
    local cleanup="$build_rootdir/cleanup.bash"
    local basedir=$srcdir/$pkgname

    _create_cleanup_script

    ###################################################
    # Build.
    ###################################################

    cd $basedir
    _select_calamares_type   # current or test

    sudo pacman -Syyu || return 1
    
    sudo ./fix_permissions.sh
    sudo ./build.sh -v
    cd ../..
    sudo mv $srcdir/$pkgname/out/*.iso .
    sudo chown $LOGNAME *.iso

    sync

    ###################################################
    # Show the result.
    ###################################################

    cd "$build_rootdir"

    echo ""
    echo "#######################################################################"
    echo ""
    echo "The new ISO is here:"
    ls -1 "$build_rootdir"/*.iso
    echo ""
    echo "To clean up all except the ISO, run command:"
    echo "    bash $cleanup"
    echo ""
    echo "#######################################################################"
    echo ""
}

package() {
    echo Done.
}

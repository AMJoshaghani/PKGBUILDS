#!/bin/bash

# Maintainer: EndeavourOS-Team <info@endeavouros.com>

pkgname=EndeavourOS-archiso
pkgver=0.2
pkgrel=2
pkgdesc="Build EndeavourOS-archiso"
arch=(any)
makedepends=(archiso arch-install-scripts git)
source=($pkgname.zip::https://github.com/endeavouros-team/EndeavourOS-archiso/archive/master.zip)
sha512sums=(29d391acb3d9698ffe5ea4b3d492110a4aaac208050ecaca871637934bb1e922b7289796c7128acb213c003b0b1e11bd0521aeea2c3f6756102aa7b5d395522d)

build() {
    local build_rootdir="$(dirname "$PWD")"   # $srcdir/..
    local _cmds=()
    local cleanup="$build_rootdir/cleanup.bash"
    local basedir=${pkgname}-master

    # create a cleanup script
    cat <<EOF > "$cleanup"
#!/bin/bash
sudo rm -f  $build_rootdir/${pkgname}-*.pkg.tar.*
sudo rm -f  $build_rootdir/${pkgname}.zip
sudo rm -rf $build_rootdir/pkg
sudo rm -rf $build_rootdir/src
EOF

    # build
    cd $basedir

    _cmds+=(pacman -Syyu \;)       # make sure system is updated

    _cmds+=(./fix_permissions.sh \;)
    _cmds+=(./build.sh -v \;)
    _cmds+=(cd "$build_rootdir" \;)
    _cmds+=(mv "$srcdir/$basedir"/out/*.iso . \;)
    _cmds+=(chown $LOGNAME:$LOGNAME *.iso)

    su -c "${_cmds[*]}"
    sync

    # show the result

    cd "$build_rootdir"

    echo ""
    echo "#######################################################################"
    echo ""
    echo "The new ISO is here:"
    ls -1 "$build_rootdir"/*.iso
    echo ""
    echo "To clean up all except the ISO, run command:"
    echo "    bash $cleanup"
    echo ""
    echo "#######################################################################"
    echo ""
}

package() {
    echo Done.
}

# Maintainers: Portergos Linux <portergoslinux@gmail.com>, EndeavourOS info@endeavouros.com
# Multipurpose installer for arch based distros

pkgname=calamares
reponame_clone=Calamares-3.2.11
reponame=calamares
pkgver=3.2.11
pkgrel=1
destdir="/usr"
pkgdesc="calamares installer for arch based distros"
arch=('any')
url="https://github.com/endeavouros-team"
license=('GPL3')
makedepends=('git')
conflicts=('calamares_offline' 'calamares_netinstall_test')
provides=("${pkgname}")
options=(!strip !emptydirs)
source=("git+https://github.com/endeavouros-team/$reponame_clone.git#branch=minimum")
sha256sums=('SKIP')

prepare() {

    git clone https://github.com/calamares/calamares.git
    rsync -va $srcdir/$reponame_clone/* $srcdir/$reponame
}

build() {


    mkdir -p $srcdir/$reponame/build/$pkgname
    cd $srcdir/$reponame/build
    rm -r $srcdir/$reponame/src/modules/{packagechooser, tracking}
    cmake .. -DCMAKE_BUILD_TYPE=Debug -DCMAKE_INSTALL_LIBDIR=/usr/lib -DCMAKE_INSTALL_PREFIX=/usr
    export DESTDIR="$srcdir/$reponame/build/$pkgname" && make -j4 install

  }

package() {
    cd $srcdir/$reponame/build/$pkgname

    cp -r $srcdir/$reponame/src/modules/netinstall/netinstall.yaml ${srcdir}/${reponame}/build/$pkgname/usr/share/calamares/

    cp -r $srcdir/$reponame/src/branding ${srcdir}/${reponame}/build/$pkgname/usr/share/calamares/

    cp -r $srcdir/$reponame/{settings.conf_offline,settings.conf_online} ${srcdir}/${reponame}/build/$pkgname/usr/share/calamares/

    cp -r $srcdir/$reponame/src/modules/welcome/{welcome.conf_online,welcome.conf_offline} ${srcdir}/${reponame}/build/$pkgname/usr/share/calamares/modules/

    cp -r $srcdir/$reponame/src/modules/packages/{packages.conf_online,packages.conf_offline} ${srcdir}/${reponame}/build/$pkgname/usr/share/calamares/modules/

    cp -r "${srcdir}/${reponame}/build/$pkgname/"* "${pkgdir}${destdir}"
}

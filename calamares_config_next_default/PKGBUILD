# Maintainer: joekamprad <joekamprad@endeavouros.com>
pkgname=calamares_config_next_default
pkgver=1.0
pkgrel=1
pkgdesc='EndeavourOS default calamares configuration files and branding'
arch=('any')
url='https://www.endeavouros.com'
license=('GPL3')
source=(
    git+https://github.com/endeavouros-team/calamares_config_next.git#branch=master
    git+https://github.com/endeavouros-team/install-scripts-next.git
)
sha512sums=('SKIP'
            'SKIP')

_caldir=$pkgname/calamares
_scriptdir=bin
_date=$(date +%Y.%m.%d)

prepare() {
    # set date for calamares_branding
    sed -i $srcdir/calamares_config_next/calamares/branding/endeavouros/branding.desc \
    -e "s|^\(    version:[ ]*\).*$|\1$_date|" \
    -e "s|^\(    shortVersion:[ ]*\).*$|\1$_date|"

    mkdir bin
    cp install-scripts-next/cleaner_script.sh           $_scriptdir/
    cp install-scripts-next/chrooted_cleaner_script.sh  $_scriptdir/
    cp install-scripts-next/update-mirrorlist           $_scriptdir/
    cp install-scripts-next/pacstrap_calamares          $_scriptdir/
    chmod +x $_scriptdir/{cleaner_script.sh,chrooted_cleaner_script.sh,update-mirrorlist,pacstrap_calamares}

    cp install-scripts-next/netinstall.yaml  $_caldir/modules/
    rm $_caldir/settings_community.conf
    rm $_caldir/modules/{contextualprocess.conf,packagechooser.conf,netinstall_community-base.conf,netinstall_community.conf}
    rm -R $_caldir/{ce,images}
}

package() {
    install -dm 755 $pkgdir/etc/calamares
    cp -r --no-preserve=ownership $_caldir $pkgdir/etc/
    install -dm 755 $pkgdir/usr/bin
    cp -r --no-preserve=ownership $_scriptdir $pkgdir/usr/

    rm -rf ../calamares_config_next ../install-scripts-next    # cleanup
}
